<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M2Belt Sync System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --belt-dark: #1a1a1a;
            --belt-texture: #262626;
            --frame-color: #475569;
            --zone1: rgba(59, 130, 246, 0.15); 
            --zone2: rgba(139, 92, 246, 0.15); 
            --zone3: rgba(236, 72, 153, 0.15); 
            --zone4: rgba(234, 179, 8, 0.15);  
            --zone5: rgba(34, 197, 94, 0.15);  
        }

        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .conveyor-container {
            position: relative;
            background: #1e293b;
            padding: 30px 20px;
            border-radius: 16px;
            border: 1px solid #334155;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.3);
        }

        .belt-wrapper {
            position: relative;
            background: #000;
            padding: 4px 0;
            border-top: 6px solid var(--frame-color);
            border-bottom: 6px solid var(--frame-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .conveyor-belt {
            height: 70px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .belt-texture {
            position: absolute;
            top: 0;
            left: -100px;
            width: calc(100% + 200px);
            height: 100%;
            background-color: var(--belt-dark);
            background-image: 
                linear-gradient(45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--belt-texture) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--belt-texture) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            opacity: 0.8;
            pointer-events: none;
        }

        .belt-shading {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 5;
        }

        .zone-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 8px;
            font-size: 0.6rem;
            letter-spacing: 0.05em;
            font-weight: 800;
            transition: all 0.3s ease;
            border-right: 2px solid rgba(255,255,255,0.05);
            z-index: 2;
        }

        .zone-active {
            background-color: rgba(255, 255, 255, 0.08) !important;
            box-shadow: inset 0 0 20px rgba(255,255,255,0.05);
            color: #fff;
        }

        .product {
            position: absolute;
            width: 44px;
            height: 44px;
            background: #e2e8f0;
            border: 2px solid #64748b;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #1e293b;
            font-weight: 900;
            font-size: 0.7rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), inset 0 2px 4px rgba(255,255,255,0.8);
            z-index: 10;
        }

        .uturn-indicator {
            height: 50px;
            background: #0f172a;
            border: 2px solid #334155;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            border-radius: 8px;
            color: #94a3b8;
            font-size: 0.8rem;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 border-b border-slate-700 pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <span class="text-3xl font-black tracking-tighter text-blue-500 italic">M2Belt</span>
                </div>
                <p class="text-slate-500 font-medium text-sm">Real-Time Time-Stamp Synchronization</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-6 bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                <div>
                    <label class="block text-[10px] uppercase text-slate-500 font-black mb-1">HQ Speed (mm/min)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider1" min="66" max="230" class="w-32 accent-blue-500">
                        <span class="text-xl font-mono text-blue-400 w-10 text-right" id="speedVal1"></span>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase text-slate-500 font-black mb-1">HT Speed (mm/min)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider2" min="120" max="144" class="w-32 accent-green-500">
                        <span class="text-xl font-mono text-green-400 w-10 text-right" id="speedVal2"></span>
                    </div>
                </div>
                
                <button id="addProduct" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-black uppercase tracking-tighter transition-all active:scale-95">
                    Load Unit
                </button>
            </div>
        </header>

        <div class="conveyor-container mb-8">
            <div class="mb-3 flex justify-between text-[10px] text-slate-400 font-black uppercase tracking-widest px-1">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                    HEAT QUENCHING (7980mm)
                </div>
                <span id="pCount" class="bg-blue-900/40 px-2 py-0.5 rounded text-blue-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt1">
                    <div class="belt-texture" id="texture1"></div>
                    <div class="belt-shading"></div>
                    <div class="zone-overlay" style="left: 0%; width: 20%;" data-belt="1" data-zone="1"><span>ZONE 1</span></div>
                    <div class="zone-overlay" style="left: 20%; width: 20%;" data-belt="1" data-zone="2"><span>ZONE 2</span></div>
                    <div class="zone-overlay" style="left: 40%; width: 20%;" data-belt="1" data-zone="3"><span>ZONE 3</span></div>
                    <div class="zone-overlay" style="left: 60%; width: 20%;" data-belt="1" data-zone="4"><span>ZONE 4</span></div>
                    <div class="zone-overlay" style="left: 80%; width: 20%;" data-belt="1" data-zone="5"><span>ZONE 5</span></div>
                </div>
            </div>

            <div class="uturn-indicator">
                <svg class="w-5 h-5 mr-3 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M12 7v5l3 3"/></svg>
                Buffer Zone (25 min) <span id="uturnCount" class="ml-3 text-white bg-blue-600 px-3 py-0.5 rounded-full text-xs">0</span>
            </div>

            <div class="mb-3 flex justify-between text-[10px] text-slate-400 font-black uppercase tracking-widest px-1">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    HEAT TEMPERING (7200mm)
                </div>
                <span id="rCount" class="bg-green-900/40 px-2 py-0.5 rounded text-green-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt2">
                    <div class="belt-texture" id="texture2"></div>
                    <div class="belt-shading"></div>
                    <div class="zone-overlay" style="left: 0%; width: 25%;" data-belt="2" data-zone="1"><span>ZONE 1</span></div>
                    <div class="zone-overlay" style="left: 25%; width: 25%;" data-belt="2" data-zone="2"><span>ZONE 2</span></div>
                    <div class="zone-overlay" style="left: 50%; width: 25%;" data-belt="2" data-zone="3"><span>ZONE 3</span></div>
                    <div class="zone-overlay" style="left: 75%; width: 25%;" data-belt="2" data-zone="4"><span>ZONE 4</span></div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900/80 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl">
            <table class="w-full text-xs text-left">
                <thead class="bg-slate-800/50 text-slate-500 uppercase font-black tracking-widest">
                    <tr>
                        <th class="px-6 py-4">Serial ID</th>
                        <th class="px-6 py-4">Status</th>
                        <th class="px-6 py-4">Linear Position</th>
                        <th class="px-6 py-4 text-right">Metrics (Remaining Time)</th>
                    </tr>
                </thead>
                <tbody id="trackingBody"></tbody>
            </table>
            <div id="emptyState" class="p-12 text-center text-slate-600 font-medium">System Idle. Load a unit to begin tracking.</div>
        </div>
    </div>

    <script>
        const P_LENGTH = 7980; 
        const R_LENGTH = 7200; 
        const UTURN_MS = 25 * 60 * 1000; 

        // DOM Elements
        const speedS1 = document.getElementById('speedSlider1');
        const speedS2 = document.getElementById('speedSlider2');
        const trackingBody = document.getElementById('trackingBody');
        const emptyState = document.getElementById('emptyState');
        const addBtn = document.getElementById('addProduct');

        // Initial state loading from LocalStorage
        const savedProducts = JSON.parse(localStorage.getItem('m2belt_products') || '[]');
        const savedCounter = parseInt(localStorage.getItem('m2belt_counter') || '1');
        
        // Load speeds or use defaults if never set
        const savedSpeedP = localStorage.getItem('m2belt_speedP') || '177';
        const savedSpeedR = localStorage.getItem('m2belt_speedR') || '120';
        
        // Sync sliders with saved values
        speedS1.value = savedSpeedP;
        speedS2.value = savedSpeedR;

        const state = {
            speedP: parseInt(savedSpeedP), 
            speedR: parseInt(savedSpeedR), 
            products: savedProducts,
            counter: savedCounter,
            lastFrameTime: performance.now(),
            textureOffsets: [0, 0]
        };

        function saveToStorage() {
            const toSave = state.products.map(p => ({
                id: p.id,
                stage: p.stage,
                startTime: p.startTime,
                returnStartTime: p.returnStartTime,
                uturnStart: p.uturnStart,
                currentPos: p.currentPos
            }));
            localStorage.setItem('m2belt_products', JSON.stringify(toSave));
            localStorage.setItem('m2belt_counter', state.counter.toString());
            localStorage.setItem('m2belt_speedP', state.speedP.toString());
            localStorage.setItem('m2belt_speedR', state.speedR.toString());
        }

        // Update speeds when sliders change
        speedS1.addEventListener('input', (e) => {
            state.speedP = parseInt(e.target.value);
            saveToStorage();
        });
        speedS2.addEventListener('input', (e) => {
            state.speedR = parseInt(e.target.value);
            saveToStorage();
        });

        function syncProductProgress(p) {
            const now = Date.now();
            let distanceTravelled, totalLength, speed;

            if (p.stage === 'p-belt') {
                const elapsedMinutes = (now - p.startTime) / 60000;
                speed = state.speedP;
                totalLength = P_LENGTH;
                distanceTravelled = speed * elapsedMinutes;
                
                return {
                    distance: Math.min(distanceTravelled, totalLength),
                    isFinished: distanceTravelled >= totalLength,
                    remainingMin: Math.max(0, (totalLength - distanceTravelled) / speed)
                };
            } 
            else if (p.stage === 'r-belt') {
                const elapsedMinutes = (now - p.returnStartTime) / 60000;
                speed = state.speedR;
                totalLength = R_LENGTH;
                distanceTravelled = speed * elapsedMinutes;

                return {
                    distance: Math.min(distanceTravelled, totalLength),
                    isFinished: distanceTravelled >= totalLength,
                    remainingMin: Math.max(0, (totalLength - distanceTravelled) / speed)
                };
            }
            return { distance: 0, isFinished: false, remainingMin: 0 };
        }

        function createProduct() {
            const id = `U-${state.counter++}`;
            state.products.push({
                id,
                stage: 'p-belt',
                startTime: Date.now(), 
                returnStartTime: null,
                uturnStart: null,
                currentPos: 0,
                element: null
            });
            saveToStorage();
            updateEmptyState();
        }

        addBtn.addEventListener('click', createProduct);

        function formatTime(totalMinutes) {
            const mins = Math.floor(totalMinutes);
            const secs = Math.floor((totalMinutes % 1) * 60);
            return `${mins}m ${secs}s`;
        }

        function animate(frameTime) {
            const now = Date.now();
            const dt = frameTime - state.lastFrameTime;
            state.lastFrameTime = frameTime;

            // Display current values
            document.getElementById('speedVal1').innerText = state.speedP;
            document.getElementById('speedVal2').innerText = state.speedR;

            state.textureOffsets[0] = (state.textureOffsets[0] + (state.speedP / 12000) * dt) % 40;
            state.textureOffsets[1] = (state.textureOffsets[1] - (state.speedR / 12000) * dt) % 40;
            document.getElementById('texture1').style.transform = `translateX(${state.textureOffsets[0]}px)`;
            document.getElementById('texture2').style.transform = `translateX(${state.textureOffsets[1]}px)`;

            const activeP = new Set();
            const activeR = new Set();
            let uturnCount = 0;
            let stateChanged = false;

            for (let i = state.products.length - 1; i >= 0; i--) {
                const p = state.products[i];
                const sync = syncProductProgress(p);

                if (p.stage === 'p-belt') {
                    p.currentPos = sync.distance;
                    const zone = Math.min(Math.floor(p.currentPos / (P_LENGTH / 5)) + 1, 5);
                    activeP.add(zone);

                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        p.element.innerHTML = `<span>${p.id}</span>`;
                        document.getElementById('belt1').appendChild(p.element);
                    }
                    
                    const pct = (p.currentPos / P_LENGTH);
                    const beltWidth = document.getElementById('belt1').offsetWidth;
                    p.element.style.transform = `translateX(${pct * beltWidth - 22}px)`;

                    if (sync.isFinished) {
                        p.stage = 'u-turn';
                        const timeNeededMs = (P_LENGTH / state.speedP) * 60000;
                        p.uturnStart = p.startTime + timeNeededMs; 
                        if (p.element) { p.element.remove(); p.element = null; }
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'u-turn') {
                    uturnCount++;
                    const elapsed = now - p.uturnStart;
                    if (elapsed >= UTURN_MS) {
                        p.stage = 'r-belt';
                        p.returnStartTime = p.uturnStart + UTURN_MS;
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'r-belt') {
                    p.currentPos = sync.distance;
                    const zone = Math.min(Math.floor(p.currentPos / (R_LENGTH / 4)) + 1, 4);
                    activeR.add(zone);

                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        p.element.style.borderColor = '#22c55e';
                        p.element.innerHTML = `<span>${p.id}</span>`;
                        document.getElementById('belt2').appendChild(p.element);
                    }

                    const pct = (p.currentPos / R_LENGTH);
                    const beltWidth = document.getElementById('belt2').offsetWidth;
                    p.element.style.transform = `translateX(${beltWidth - (pct * beltWidth) - 22}px)`;

                    if (sync.isFinished) {
                        if (p.element) p.element.remove();
                        state.products.splice(i, 1);
                        stateChanged = true;
                        updateEmptyState();
                    }
                }
            }

            if (stateChanged) saveToStorage();

            updateZones(activeP, activeR);
            document.getElementById('uturnCount').innerText = uturnCount;
            document.getElementById('pCount').innerText = `Units: ${state.products.filter(x => x.stage === 'p-belt').length}`;
            document.getElementById('rCount').innerText = `Units: ${state.products.filter(x => x.stage === 'r-belt').length}`;

            if (state.products.length > 0) renderTable();
            requestAnimationFrame(animate);
        }

        function updateZones(activeP, activeR) {
            document.querySelectorAll('.zone-overlay').forEach(el => {
                const b = el.dataset.belt;
                const z = parseInt(el.dataset.zone);
                if ((b == "1" && activeP.has(z)) || (b == "2" && activeR.has(z))) {
                    el.classList.add('zone-active');
                } else {
                    el.classList.remove('zone-active');
                }
            });
        }

        function renderTable() {
            let html = '';
            const now = Date.now();
            state.products.forEach(p => {
                const sync = syncProductProgress(p);
                let status = `<span class="bg-blue-900/40 text-blue-400 px-2 py-0.5 rounded font-black tracking-tighter">HQ BELT</span>`;
                let metrics = formatTime(sync.remainingMin);

                if (p.stage === 'u-turn') {
                    status = `<span class="bg-amber-900/40 text-amber-400 px-2 py-0.5 rounded font-black tracking-tighter">BUFFER</span>`;
                    const remMs = Math.max(0, UTURN_MS - (now - p.uturnStart));
                    metrics = formatTime(remMs / 60000);
                } else if (p.stage === 'r-belt') {
                    status = `<span class="bg-green-900/40 text-green-400 px-2 py-0.5 rounded font-black tracking-tighter">HT BELT</span>`;
                }

                html += `<tr class="border-t border-slate-800/50 hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4 font-black text-slate-300 tracking-tighter">${p.id}</td>
                    <td class="px-6 py-4">${status}</td>
                    <td class="px-6 py-4 font-mono text-slate-400">${p.stage === 'u-turn' ? 'Queued' : p.currentPos.toFixed(0) + ' mm'}</td>
                    <td class="px-6 py-4 text-right font-mono text-slate-500">Remaining: ${metrics}</td>
                </tr>`;
            });
            trackingBody.innerHTML = html;
        }

        function updateEmptyState() { 
            emptyState.style.display = state.products.length === 0 ? 'block' : 'none'; 
        }

        // Initialize display
        updateEmptyState();
        requestAnimationFrame(animate);
    </script>
</body>
</html>