<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M2Belt Sync System | Zone Tracking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --belt-dark: #1a1a1a;
            --belt-texture: #262626;
            --frame-color: #475569;
        }

        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow-x: hidden;
        }

        .conveyor-container {
            position: relative;
            background: #1e293b;
            padding: 30px 20px;
            border-radius: 16px;
            border: 1px solid #334155;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.3);
        }

        .belt-wrapper {
            position: relative;
            background: #000;
            padding: 4px 0;
            border-top: 6px solid var(--frame-color);
            border-bottom: 6px solid var(--frame-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .conveyor-belt {
            height: 70px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        .belt-texture {
            position: absolute;
            top: 0;
            left: -100px;
            width: calc(100% + 200px);
            height: 100%;
            background-color: var(--belt-dark);
            background-image: 
                linear-gradient(45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--belt-texture) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--belt-texture) 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            opacity: 0.8;
            pointer-events: none;
        }

        .belt-shading {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.4) 0%, transparent 20%, transparent 80%, rgba(0,0,0,0.4) 100%);
            pointer-events: none;
            z-index: 5;
        }

        .zone-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 8px;
            font-size: 0.6rem;
            letter-spacing: 0.05em;
            font-weight: 800;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.05);
            z-index: 2;
        }

        .zone-active {
            background-color: rgba(255, 255, 255, 0.12) !important;
            box-shadow: inset 0 0 25px rgba(255,255,255,0.08);
            color: #fff;
        }

        .product {
            position: absolute;
            width: 44px;
            height: 44px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.6rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.6), inset 0 1px 1px rgba(255,255,255,0.3);
            z-index: 10;
            transition: transform 0.1s linear; 
            will-change: transform;
            text-align: center;
            overflow: hidden;
            padding: 2px;
            color: #ffffff; 
            border: 1px solid rgba(255,255,255,0.2);
        }

        .process-tank-container {
            background: #0f172a;
            border: 2px solid #334155;
            padding: 15px;
            margin: 15px 0;
            border-radius: 12px;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.5);
        }

        .tank-segment {
            height: 8px;
            transition: all 0.3s ease;
        }

        .tank-segment.active {
            box-shadow: 0 0 10px currentColor;
            filter: brightness(1.5);
        }

        #inputModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(8px);
        }

        #notification-center {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notif-toast {
            background: #1e293b;
            border-left: 4px solid #3b82f6;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
            min-width: 280px;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="notification-center"></div>

    <!-- Modal for Loading Product -->
    <div id="inputModal">
        <div class="bg-slate-800 p-8 rounded-2xl border border-slate-700 w-full max-w-md shadow-2xl">
            <h3 class="text-2xl font-black mb-6 text-blue-400 italic">LOAD NEW UNIT</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Product Name (1 to 9)</label>
                    <input type="text" id="modalProdName" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none text-white font-bold" placeholder="e.g. 5">
                    <p id="errorName" class="text-red-500 text-[10px] mt-1 font-bold hidden">Only numbers 1-9 allowed.</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Start Time</label>
                        <input type="time" id="modalStartTime" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white">
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Target Exit</label>
                        <input type="time" id="modalFinishTime" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white">
                    </div>
                </div>
                <div class="flex gap-4 pt-4">
                    <button id="cancelLoad" class="flex-1 px-4 py-3 rounded-xl bg-slate-700 font-black text-slate-300 uppercase">Cancel</button>
                    <button id="confirmLoad" class="flex-1 px-4 py-3 rounded-xl bg-blue-600 font-black text-white shadow-lg shadow-blue-500/20 uppercase">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-8 border-b border-slate-700 pb-6 flex flex-col md:flex-row justify-between items-end gap-4">
            <div>
                <div class="flex items-center gap-3">
                    <span class="text-3xl font-black tracking-tighter text-blue-500 italic">M2Belt</span>
                    <span class="bg-blue-500/10 text-blue-500 text-[10px] px-2 py-1 rounded font-black border border-blue-500/20">v2.1 SYNC</span>
                </div>
                <p class="text-slate-500 font-medium text-sm">Industrial Thermal Process Monitoring</p>
            </div>
            
            <div class="flex flex-wrap items-center gap-6 bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                <div class="flex items-center gap-4">
                    <button id="requestNotif" class="text-[10px] font-black uppercase text-slate-400 hover:text-white transition-colors">
                        ðŸ”” Enable Desktop Alerts
                    </button>
                </div>
                <div>
                    <label class="block text-[10px] uppercase text-slate-500 font-black mb-1">HQ SPEED</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider1" min="66" max="230" value="177" class="w-32 accent-blue-500">
                        <span class="text-xl font-mono text-blue-400 w-12 text-right" id="speedVal1">177</span>
                    </div>
                </div>
                <div>
                    <label class="block text-[10px] uppercase text-slate-500 font-black mb-1">HT SPEED</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider2" min="120" max="144" value="120" class="w-32 accent-green-500">
                        <span class="text-xl font-mono text-green-400 w-12 text-right" id="speedVal2">120</span>
                    </div>
                </div>
                <button id="openModal" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-lg font-black uppercase tracking-tighter transition-all active:scale-95">
                    Add Unit
                </button>
            </div>
        </header>

        <div class="conveyor-container mb-8">
            <!-- HQ BELT -->
            <div class="mb-3 flex justify-between text-[10px] text-slate-400 font-black uppercase tracking-widest px-1">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></div>
                    HEAT QUENCHING (7980mm)
                </div>
                <span id="pCount" class="bg-blue-900/40 px-2 py-0.5 rounded text-blue-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt1">
                    <div class="belt-texture" id="texture1"></div>
                    <div class="belt-shading"></div>
                    <div class="zone-overlay" style="left: 0%; width: 20%;" data-belt="1" data-zone="1"><span>ZONE 1</span></div>
                    <div class="zone-overlay" style="left: 20%; width: 20%;" data-belt="1" data-zone="2"><span>ZONE 2</span></div>
                    <div class="zone-overlay" style="left: 40%; width: 20%;" data-belt="1" data-zone="3"><span>ZONE 3</span></div>
                    <div class="zone-overlay" style="left: 60%; width: 20%;" data-belt="1" data-zone="4"><span>ZONE 4</span></div>
                    <div class="zone-overlay" style="left: 80%; width: 20%;" data-belt="1" data-zone="5"><span>ZONE 5</span></div>
                </div>
            </div>

            <!-- THE OIL BELT (SEGMENTED) -->
            <div class="process-tank-container">
                <div class="flex justify-between items-center mb-2">
                    <div class="text-[11px] font-black text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        <svg class="w-4 h-4 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        OIL BELT PROCESS (25 MIN)
                    </div>
                    <span id="uturnCount" class="text-white bg-blue-600 px-3 py-0.5 rounded-full text-[10px] font-black">0</span>
                </div>

                <div class="w-full flex gap-1 items-end h-10 mb-2">
                    <div id="tank-oil" class="tank-segment bg-amber-600/20 text-amber-500/40 rounded flex items-center justify-center text-[9px] font-black uppercase" style="width: 60%">OIL (15m)</div>
                    <div id="tank-water" class="tank-segment bg-blue-600/20 text-blue-500/40 rounded flex items-center justify-center text-[9px] font-black uppercase" style="width: 20%">WATER (5m)</div>
                    <div id="tank-fall" class="tank-segment bg-indigo-600/20 text-indigo-500/40 rounded flex items-center justify-center text-[9px] font-black uppercase" style="width: 20%">FALL (5m)</div>
                </div>
                
                <div class="w-full h-1.5 bg-slate-800 rounded-full flex overflow-hidden">
                    <div class="h-full bg-amber-500/60" style="width: 60%"></div>
                    <div class="h-full bg-blue-500/60" style="width: 20%"></div>
                    <div class="h-full bg-indigo-500/60" style="width: 20%"></div>
                </div>
            </div>

            <!-- HT BELT -->
            <div class="mb-3 flex justify-between text-[10px] text-slate-400 font-black uppercase tracking-widest px-1">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                    HEAT TEMPERING (7200mm)
                </div>
                <span id="rCount" class="bg-green-900/40 px-2 py-0.5 rounded text-green-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt2">
                    <div class="belt-texture" id="texture2"></div>
                    <div class="belt-shading"></div>
                    <div class="zone-overlay" style="left: 0%; width: 25%;" data-belt="2" data-zone="1"><span>ZONE 1</span></div>
                    <div class="zone-overlay" style="left: 25%; width: 25%;" data-belt="2" data-zone="2"><span>ZONE 2</span></div>
                    <div class="zone-overlay" style="left: 50%; width: 25%;" data-belt="2" data-zone="3"><span>ZONE 3</span></div>
                    <div class="zone-overlay" style="left: 75%; width: 25%;" data-belt="2" data-zone="4"><span>ZONE 4</span></div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900/80 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl">
            <table class="w-full text-xs text-left">
                <thead class="bg-slate-800/50 text-slate-500 uppercase font-black tracking-widest">
                    <tr>
                        <th class="px-6 py-4">ID / Unit Name</th>
                        <th class="px-6 py-4">Cycle Times</th>
                        <th class="px-6 py-4 text-center">Position</th>
                        <th class="px-6 py-4">Process Stage</th>
                        <th class="px-6 py-4 text-right">Countdown</th>
                    </tr>
                </thead>
                <tbody id="trackingBody"></tbody>
            </table>
            <div id="emptyState" class="p-12 text-center text-slate-600 font-medium italic">Pipeline empty. Load unit to begin.</div>
        </div>
    </div>

    <script>
        const P_LENGTH = 7980; 
        const R_LENGTH = 7200; 
        const UTURN_MS = 25 * 60 * 1000; 

        // DOM
        const speedS1 = document.getElementById('speedSlider1');
        const speedS2 = document.getElementById('speedSlider2');
        const trackingBody = document.getElementById('trackingBody');
        const emptyState = document.getElementById('emptyState');
        const openModalBtn = document.getElementById('openModal');
        const inputModal = document.getElementById('inputModal');
        const cancelLoad = document.getElementById('cancelLoad');
        const confirmLoad = document.getElementById('confirmLoad');
        const modalProdName = document.getElementById('modalProdName');
        const errorName = document.getElementById('errorName');
        const notifContainer = document.getElementById('notification-center');

        // Initial State
        const savedProducts = JSON.parse(localStorage.getItem('m2belt_products') || '[]');
        const savedCounter = parseInt(localStorage.getItem('m2belt_counter') || '0');
        const state = {
            speedP: parseInt(localStorage.getItem('m2belt_speedP') || '177'), 
            speedR: parseInt(localStorage.getItem('m2belt_speedR') || '120'), 
            products: savedProducts,
            counter: savedCounter,
            lastFrameTime: performance.now(),
            textureOffsets: [0, 0]
        };

        const PRODUCT_COLORS = ["#22c55e", "#ef4444", "#3b82f6", "#a855f7", "#f59e0b", "#ec4899", "#14b8a6"];

        function notify(msg, isProcess = false) {
            const toast = document.createElement('div');
            toast.className = 'notif-toast';
            if(isProcess) toast.style.borderLeftColor = '#f59e0b';
            toast.innerHTML = `<div class="text-[9px] font-black text-blue-500 uppercase tracking-widest mb-1">SYSTEM ALERT</div>
                               <div class="text-white font-bold text-sm">${msg}</div>`;
            notifContainer.appendChild(toast);
            setTimeout(() => toast.remove(), 6000);
            
            // Native Browser Notification
            if (Notification.permission === "granted") {
                new Notification("M2Belt Sync", { body: msg });
            }
        }

        document.getElementById('requestNotif').onclick = () => {
            Notification.requestPermission().then(perm => {
                if(perm === 'granted') notify("Notifications Enabled Successfully");
            });
        };

        function saveToStorage() {
            const cleanData = state.products.map(p => ({
                id: p.id, name: p.name, stage: p.stage,
                startTime: p.startTime, returnStartTime: p.returnStartTime,
                uturnStart: p.uturnStart, currentPos: p.currentPos,
                entryClock: p.entryClock, exitClock: p.exitClock,
                color: p.color, notifiedWater: p.notifiedWater, notifiedFall: p.notifiedFall,
                subZone: p.subZone
            }));
            localStorage.setItem('m2belt_products', JSON.stringify(cleanData));
            localStorage.setItem('m2belt_counter', state.counter.toString());
            localStorage.setItem('m2belt_speedP', state.speedP.toString());
            localStorage.setItem('m2belt_speedR', state.speedR.toString());
        }

        speedS1.oninput = (e) => { state.speedP = parseInt(e.target.value); saveToStorage(); };
        speedS2.oninput = (e) => { state.speedR = parseInt(e.target.value); saveToStorage(); };

        function syncProgress(p) {
            const now = Date.now();
            if (p.stage === 'p-belt') {
                const elapsedMin = (now - p.startTime) / 60000;
                const dist = state.speedP * elapsedMin;
                return { dist: Math.min(dist, P_LENGTH), isFin: dist >= P_LENGTH, rem: Math.max(0, (P_LENGTH - dist) / state.speedP) };
            } else if (p.stage === 'r-belt') {
                const elapsedMin = (now - p.returnStartTime) / 60000;
                const dist = state.speedR * elapsedMin;
                return { dist: Math.min(dist, R_LENGTH), isFin: dist >= R_LENGTH, rem: Math.max(0, (R_LENGTH - dist) / state.speedR) };
            }
            return { dist: 0, isFin: false, rem: 0 };
        }

        openModalBtn.onclick = () => { inputModal.style.display = 'flex'; errorName.classList.add('hidden'); };
        cancelLoad.onclick = () => { inputModal.style.display = 'none'; };
        
        confirmLoad.onclick = () => {
            const name = modalProdName.value.trim();
            if (!/^[1-9]$/.test(name)) { errorName.classList.remove('hidden'); return; }

            const startOver = document.getElementById('modalStartTime').value;
            const endOver = document.getElementById('modalFinishTime').value;

            let now = Date.now();
            if (startOver) {
                const [h, m] = startOver.split(':');
                const d = new Date(); d.setHours(h, m, 0, 0);
                now = d.getTime();
            }

            const hqDur = (P_LENGTH / state.speedP) * 60000;
            const htDur = (R_LENGTH / state.speedR) * 60000;
            let estExit = now + hqDur + UTURN_MS + htDur;

            if (endOver) {
                const [h, m] = endOver.split(':');
                const d = new Date(); d.setHours(h, m, 0, 0);
                estExit = d.getTime();
            }

            state.counter++;
            state.products.push({
                id: `U${name}`, name, stage: 'p-belt', startTime: now,
                returnStartTime: null, uturnStart: null, currentPos: 0,
                entryClock: now, exitClock: estExit, element: null,
                color: PRODUCT_COLORS[state.counter % PRODUCT_COLORS.length],
                notifiedWater: false, notifiedFall: false, subZone: "OIL ZONE"
            });

            modalProdName.value = '';
            inputModal.style.display = 'none';
            saveToStorage();
            updateEmptyState();
        };

        function formatClock(ts) {
            if (!ts) return "--:--";
            return new Date(ts).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
        }

        function formatTimeRemaining(m) {
            const mins = Math.floor(m);
            const secs = Math.floor((m % 1) * 60);
            return `${mins}m ${secs}s`;
        }

        function animate(frameTime) {
            const now = Date.now();
            const dt = frameTime - state.lastFrameTime;
            state.lastFrameTime = frameTime;

            document.getElementById('speedVal1').innerText = state.speedP;
            document.getElementById('speedVal2').innerText = state.speedR;

            state.textureOffsets[0] = (state.textureOffsets[0] + (state.speedP / 12000) * dt) % 40;
            state.textureOffsets[1] = (state.textureOffsets[1] - (state.speedR / 12000) * dt) % 40;
            document.getElementById('texture1').style.transform = `translateX(${state.textureOffsets[0]}px)`;
            document.getElementById('texture2').style.transform = `translateX(${state.textureOffsets[1]}px)`;

            const activeP = new Set(), activeR = new Set();
            let uturnCount = 0;
            let stateChanged = false;
            
            // Tank sub-zone tracking for UI highlighting
            let subZonePresence = { oil: false, water: false, fall: false };

            for (let i = state.products.length - 1; i >= 0; i--) {
                const p = state.products[i];
                const sync = syncProgress(p);

                if (p.stage === 'p-belt') {
                    p.currentPos = sync.dist;
                    activeP.add(Math.min(Math.floor(p.currentPos / (P_LENGTH / 5)) + 1, 5));
                    
                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        document.getElementById('belt1').appendChild(p.element);
                    }
                    p.element.style.backgroundColor = p.color;
                    p.element.innerHTML = `<span class="opacity-60 text-[7px] font-black">${p.id}</span><span class="font-black text-[12px]">${p.name}</span>`;
                    const pct = (p.currentPos / P_LENGTH);
                    p.element.style.transform = `translateX(${pct * (document.getElementById('belt1').offsetWidth - 44)}px)`;

                    if (sync.isFin) {
                        p.stage = 'u-turn';
                        p.uturnStart = p.startTime + ((P_LENGTH / state.speedP) * 60000);
                        if (p.element) { p.element.remove(); p.element = null; }
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'u-turn') {
                    uturnCount++;
                    const elapsedMs = now - p.uturnStart;
                    const elapsedMin = elapsedMs / 60000;

                    // Sub-zone Logic
                    if (elapsedMin < 15) {
                        p.subZone = "OIL ZONE";
                        subZonePresence.oil = true;
                    } else if (elapsedMin < 20) {
                        p.subZone = "WATER ZONE";
                        subZonePresence.water = true;
                        if (!p.notifiedWater) {
                            notify(`Unit ${p.name} entering WATER ZONE`, true);
                            p.notifiedWater = true;
                            stateChanged = true;
                        }
                    } else {
                        p.subZone = "FALL ZONE";
                        subZonePresence.fall = true;
                        if (!p.notifiedFall) {
                            notify(`Unit ${p.name} entering FALL ZONE`, true);
                            p.notifiedFall = true;
                            stateChanged = true;
                        }
                    }

                    if (elapsedMs >= UTURN_MS) {
                        p.stage = 'r-belt';
                        p.returnStartTime = p.uturnStart + UTURN_MS;
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'r-belt') {
                    p.currentPos = sync.dist;
                    activeR.add(Math.min(Math.floor(p.currentPos / (R_LENGTH / 4)) + 1, 4));

                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        document.getElementById('belt2').appendChild(p.element);
                    }
                    p.element.style.backgroundColor = p.color;
                    p.element.innerHTML = `<span class="opacity-60 text-[7px] font-black">${p.id}</span><span class="font-black text-[12px]">${p.name}</span>`;
                    const pct = (p.currentPos / R_LENGTH);
                    const bWidth = document.getElementById('belt2').offsetWidth;
                    p.element.style.transform = `translateX(${(bWidth - 44) - (pct * (bWidth - 44))}px)`;

                    if (sync.isFin) {
                        if (p.element) p.element.remove();
                        state.products.splice(i, 1);
                        stateChanged = true;
                        updateEmptyState();
                    }
                }
            }

            if (stateChanged) saveToStorage();
            
            // Visual Zone Updates
            document.querySelectorAll('.zone-overlay').forEach(el => {
                const b = el.dataset.belt, z = parseInt(el.dataset.zone);
                if ((b == "1" && activeP.has(z)) || (b == "2" && activeR.has(z))) el.classList.add('zone-active');
                else el.classList.remove('zone-active');
            });

            // Tank Highlighting
            const tankOil = document.getElementById('tank-oil');
            const tankWater = document.getElementById('tank-water');
            const tankFall = document.getElementById('tank-fall');
            
            if (subZonePresence.oil) { tankOil.classList.add('active', 'bg-amber-500/40', 'text-amber-200'); } 
            else { tankOil.classList.remove('active', 'bg-amber-500/40', 'text-amber-200'); }
            
            if (subZonePresence.water) { tankWater.classList.add('active', 'bg-blue-500/40', 'text-blue-200'); } 
            else { tankWater.classList.remove('active', 'bg-blue-500/40', 'text-blue-200'); }
            
            if (subZonePresence.fall) { tankFall.classList.add('active', 'bg-indigo-500/40', 'text-indigo-200'); } 
            else { tankFall.classList.remove('active', 'bg-indigo-500/40', 'text-indigo-200'); }

            document.getElementById('uturnCount').innerText = uturnCount;
            document.getElementById('pCount').innerText = `Units: ${state.products.filter(x => x.stage === 'p-belt').length}`;
            document.getElementById('rCount').innerText = `Units: ${state.products.filter(x => x.stage === 'r-belt').length}`;

            if (state.products.length > 0) renderTable();
            requestAnimationFrame(animate);
        }

        function renderTable() {
            let html = '';
            const now = Date.now();
            state.products.forEach(p => {
                const sync = syncProgress(p);
                let status = `<span class="bg-blue-900/40 text-blue-400 px-2 py-0.5 rounded font-black tracking-tighter">HQ BELT</span>`;
                let remTxt = formatTimeRemaining(sync.rem);

                if (p.stage === 'u-turn') {
                    const zoneClasses = {
                        "OIL ZONE": "bg-amber-900/40 text-amber-400 border-amber-500/30",
                        "WATER ZONE": "bg-blue-900/40 text-blue-400 border-blue-500/30",
                        "FALL ZONE": "bg-indigo-900/40 text-indigo-400 border-indigo-500/30"
                    };
                    status = `<span class="${zoneClasses[p.subZone]} px-2 py-0.5 rounded font-black border animate-pulse">${p.subZone}</span>`;
                    remTxt = formatTimeRemaining((UTURN_MS - (now - p.uturnStart)) / 60000);
                } else if (p.stage === 'r-belt') {
                    status = `<span class="bg-green-900/40 text-green-400 px-2 py-0.5 rounded font-black tracking-tighter">HT BELT</span>`;
                }

                html += `<tr class="border-t border-slate-800/50 hover:bg-white/5 transition-colors">
                    <td class="px-6 py-4">
                        <div class="font-black text-slate-200 tracking-tighter flex items-center gap-2">
                            <div class="w-2.5 h-2.5 rounded-sm" style="background-color: ${p.color}"></div> ${p.name}
                        </div>
                        <div class="text-[9px] text-slate-500 font-bold mt-1 uppercase tracking-widest ml-4">${p.id}</div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="text-blue-400 font-mono text-[11px] font-bold">IN: ${formatClock(p.entryClock)}</div>
                        <div class="text-green-400 font-mono text-[11px] font-bold mt-1">OUT: ${formatClock(p.exitClock)}</div>
                    </td>
                    <td class="px-6 py-4 text-center font-mono text-slate-400 text-[11px]">${p.stage === 'u-turn' ? 'TANK-PROC' : p.currentPos.toFixed(0) + ' mm'}</td>
                    <td class="px-6 py-4">${status}</td>
                    <td class="px-6 py-4 text-right font-mono text-slate-500 font-bold">${remTxt}</td>
                </tr>`;
            });
            trackingBody.innerHTML = html;
        }

        function updateEmptyState() { emptyState.style.display = state.products.length === 0 ? 'block' : 'none'; }
        
        updateEmptyState();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
