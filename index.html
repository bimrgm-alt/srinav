<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M2Belt Sync System | Zone Tracking</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --belt-dark: #1a1a1a;
            --belt-texture: #262626;
            --frame-color: #475569;
        }

        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        .conveyor-container {
            position: relative;
            background: #1e293b;
            padding: 20px 10px;
            border-radius: 16px;
            border: 1px solid #334155;
            box-shadow: inset 0 0 40px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .conveyor-container {
                padding: 30px 20px;
            }
        }

        .belt-wrapper {
            position: relative;
            background: #000;
            padding: 4px 0;
            border-top: 4px solid var(--frame-color);
            border-bottom: 4px solid var(--frame-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            margin-bottom: 5px;
        }

        .conveyor-belt {
            height: 60px;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
        }

        @media (min-width: 768px) {
            .conveyor-belt { height: 75px; }
        }

        .belt-texture {
            position: absolute;
            top: 0;
            left: -100px;
            width: calc(100% + 200px);
            height: 100%;
            background-color: var(--belt-dark);
            background-image: 
                linear-gradient(45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(-45deg, var(--belt-texture) 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, var(--belt-texture) 75%), 
                linear-gradient(-45deg, transparent 75%, var(--belt-texture) 75%);
            background-size: 20px 20px;
            opacity: 0.8;
            pointer-events: none;
        }

        .zone-overlay {
            position: absolute;
            top: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 4px;
            font-size: 0.55rem;
            letter-spacing: 0.05em;
            font-weight: 800;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(255,255,255,0.05);
            z-index: 2;
            pointer-events: none;
        }

        .zone-active {
            background-color: rgba(255, 255, 255, 0.12) !important;
            box-shadow: inset 0 0 25px rgba(255,255,255,0.08);
            color: #fff;
        }

        .product {
            position: absolute;
            width: 38px;
            height: 38px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            font-size: 0.55rem;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.6), inset 0 1px 1px rgba(255,255,255,0.3);
            z-index: 10;
            will-change: transform;
            text-align: center;
            overflow: hidden;
            padding: 2px;
            color: #ffffff; 
            border: 1px solid rgba(255,255,255,0.2);
        }

        @media (min-width: 768px) {
            .product { width: 44px; height: 44px; font-size: 0.6rem; }
        }

        .process-tank-container {
            background: #0f172a;
            border: 1px solid #334155;
            padding: 12px;
            margin: 12px 0;
            border-radius: 12px;
        }

        .tank-segment {
            height: 10px;
            transition: all 0.3s ease;
        }

        .tank-segment.active {
            box-shadow: 0 0 10px currentColor;
            filter: brightness(1.5);
        }

        #inputModal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 200;
            backdrop-filter: blur(8px);
            padding: 20px;
        }

        #notification-center {
            position: fixed;
            top: 10px;
            right: 10px;
            left: 10px;
            z-index: 500;
            display: flex;
            flex-direction: column;
            gap: 8px;
            pointer-events: none;
        }

        @media (min-width: 768px) {
            #notification-center {
                left: auto;
                width: 320px;
                top: 20px;
                right: 20px;
            }
        }

        .notif-toast {
            background: #1e293b;
            border-left: 4px solid #3b82f6;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
            animation: slideIn 0.3s ease-out;
            pointer-events: auto;
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        input[type="range"] {
            height: 32px;
        }
    </style>
</head>
<body class="p-3 md:p-8">

    <div id="notification-center"></div>

    <!-- Modal for Loading Product -->
    <div id="inputModal">
        <div class="bg-slate-800 p-6 md:p-8 rounded-2xl border border-slate-700 w-full max-w-md shadow-2xl">
            <h3 class="text-xl md:text-2xl font-black mb-6 text-blue-400 italic">LOAD NEW UNIT</h3>
            <div class="space-y-5">
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Product Name (001-045)</label>
                    <input type="text" id="modalProdName" inputmode="numeric" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 focus:ring-2 focus:ring-blue-500 outline-none text-white font-bold" placeholder="001">
                    <p id="errorName" class="text-red-500 text-[10px] mt-1 font-bold hidden">Invalid Name. Use 001 through 045.</p>
                </div>
                <div>
                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1">Process Start Time</label>
                    <input type="time" id="modalStartTime" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-3 text-white">
                </div>
                <div class="flex gap-3 pt-4">
                    <button id="cancelLoad" class="flex-1 px-4 py-3 rounded-xl bg-slate-700 font-black text-slate-300 uppercase text-xs">Cancel</button>
                    <button id="confirmLoad" class="flex-1 px-4 py-3 rounded-xl bg-blue-600 font-black text-white shadow-lg shadow-blue-500/20 uppercase text-xs">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-6xl mx-auto">
        <header class="mb-6 border-b border-slate-700 pb-6 flex flex-col lg:flex-row justify-between lg:items-end gap-6">
            <div>
                <div class="flex items-center gap-3">
                    <span class="text-2xl md:text-3xl font-black tracking-tighter text-blue-500 italic">M-2</span>
                    <span class="bg-blue-500/10 text-blue-500 text-[10px] px-2 py-1 rounded font-black border border-blue-500/20">v2.7 VIKIRG</span>
                </div>
                <p class="text-slate-500 font-medium text-xs md:text-sm">Regmi Bimal Sync System</p>
            </div>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:flex items-center gap-4 bg-slate-900/50 p-4 rounded-xl border border-slate-800">
                <div class="sm:col-span-2 lg:col-auto border-b lg:border-b-0 lg:border-r border-slate-700 pb-3 lg:pb-0 lg:pr-4 flex items-center justify-between lg:block">
                     <button id="requestNotif" class="text-[10px] font-black uppercase text-slate-400 hover:text-white transition-colors">
                        ðŸ”” Alerts
                    </button>
                    <button id="openModal" class="lg:hidden bg-blue-600 text-white px-4 py-2 rounded-lg font-black uppercase text-[10px]">Add Unit</button>
                </div>
                <div>
                    <label class="block text-[9px] uppercase text-slate-500 font-black mb-1">HQ SPEED (mm/min)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider1" min="66" max="230" value="177" class="flex-grow lg:w-32 accent-blue-500">
                        <span class="text-lg font-mono text-blue-400 w-10 text-right" id="speedVal1">177</span>
                    </div>
                </div>
                <div>
                    <label class="block text-[9px] uppercase text-slate-500 font-black mb-1">HT SPEED (mm/min)</label>
                    <div class="flex items-center gap-3">
                        <input type="range" id="speedSlider2" min="120" max="144" value="120" class="flex-grow lg:w-32 accent-green-500">
                        <span class="text-lg font-mono text-green-400 w-10 text-right" id="speedVal2">120</span>
                    </div>
                </div>
                <button id="openModalDesktop" class="hidden lg:block bg-blue-600 hover:bg-blue-500 text-white px-6 py-3 rounded-lg font-black uppercase text-xs tracking-tighter transition-all active:scale-95">
                    Add Unit
                </button>
            </div>
        </header>

        <div class="conveyor-container mb-6 overflow-hidden">
            <!-- HQ BELT -->
            <div class="mb-2 flex justify-between text-[9px] text-slate-400 font-black uppercase tracking-widest px-1">
                <span class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 rounded-full bg-blue-500"></div> HQ (7.98m)</span>
                <span id="pCount" class="text-blue-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt1">
                    <div class="belt-texture" id="texture1"></div>
                    <div class="zone-overlay" style="left: 0%; width: 20%;" data-belt="1" data-zone="1"><span>Z1</span></div>
                    <div class="zone-overlay" style="left: 20%; width: 20%;" data-belt="1" data-zone="2"><span>Z2</span></div>
                    <div class="zone-overlay" style="left: 40%; width: 20%;" data-belt="1" data-zone="3"><span>Z3</span></div>
                    <div class="zone-overlay" style="left: 60%; width: 20%;" data-belt="1" data-zone="4"><span>Z4</span></div>
                    <div class="zone-overlay" style="left: 80%; width: 20%;" data-belt="1" data-zone="5"><span>Z5</span></div>
                </div>
            </div>

            <!-- OIL PROCESS BELT (Visualizes the U-Turn) -->
            <div class="process-tank-container">
                <div class="flex justify-between items-center mb-2 px-1">
                    <div class="text-[10px] font-black text-slate-300 uppercase tracking-widest flex items-center gap-2">
                        OIL PROCESS (25M)
                    </div>
                    <span id="uturnCount" class="text-white bg-amber-600 px-2 py-0.5 rounded-full text-[9px] font-black">0</span>
                </div>

                <div class="belt-wrapper !mb-1 !border-none !shadow-none bg-slate-900/40 rounded-lg">
                    <div class="conveyor-belt !h-[50px] md:!h-[60px]" id="beltTank">
                         <!-- Visual dividers for stages -->
                         <div id="tank-oil" class="zone-overlay bg-amber-600/5 text-amber-500/40" style="left: 0%; width: 60%; border-right: 1px dashed rgba(245,158,11,0.2);"><span>OIL</span></div>
                         <div id="tank-water" class="zone-overlay bg-blue-600/5 text-blue-500/40" style="left: 60%; width: 20%; border-right: 1px dashed rgba(59,130,246,0.2);"><span>H2O</span></div>
                         <div id="tank-fall" class="zone-overlay bg-indigo-600/5 text-indigo-500/40" style="left: 80%; width: 20%;"><span>FALL</span></div>
                    </div>
                </div>
            </div>

            <!-- HT BELT -->
            <div class="mb-2 flex justify-between text-[9px] text-slate-400 font-black uppercase tracking-widest px-1">
                <span class="flex items-center gap-1.5"><div class="w-1.5 h-1.5 rounded-full bg-green-500"></div> HT (7.20m)</span>
                <span id="rCount" class="text-green-300">Units: 0</span>
            </div>
            
            <div class="belt-wrapper">
                <div class="conveyor-belt" id="belt2">
                    <div class="belt-texture" id="texture2"></div>
                    <div class="zone-overlay" style="left: 0%; width: 25%;" data-belt="2" data-zone="1"><span>Z1</span></div>
                    <div class="zone-overlay" style="left: 25%; width: 25%;" data-belt="2" data-zone="2"><span>Z2</span></div>
                    <div class="zone-overlay" style="left: 50%; width: 25%;" data-belt="2" data-zone="3"><span>Z3</span></div>
                    <div class="zone-overlay" style="left: 75%; width: 25%;" data-belt="2" data-zone="4"><span>Z4</span></div>
                </div>
            </div>
        </div>

        <div class="bg-slate-900/80 rounded-2xl border border-slate-800 overflow-hidden shadow-2xl">
            <div class="table-responsive">
                <table class="w-full text-[11px] md:text-xs text-left min-w-[600px]">
                    <thead class="bg-slate-800/50 text-slate-500 uppercase font-black tracking-widest">
                        <tr>
                            <th class="px-4 md:px-6 py-4">Unit / ID</th>
                            <th class="px-4 md:px-6 py-4">Timing</th>
                            <th class="px-4 md:px-6 py-4 text-center">Pos</th>
                            <th class="px-4 md:px-6 py-4">Stage</th>
                            <th class="px-4 md:px-6 py-4 text-right">Timer</th>
                        </tr>
                    </thead>
                    <tbody id="trackingBody"></tbody>
                </table>
            </div>
            <div id="emptyState" class="p-12 text-center text-slate-600 font-medium italic text-sm">Pipeline empty. Load unit to begin.</div>
        </div>
    </div>

    <script>
        // PWA Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('SW registration failed:', err));
            });
        }

        const P_LENGTH = 7980; 
        const R_LENGTH = 7200; 
        const UTURN_MS = 25 * 60 * 1000; 

        // DOM
        const speedS1 = document.getElementById('speedSlider1');
        const speedS2 = document.getElementById('speedSlider2');
        const trackingBody = document.getElementById('trackingBody');
        const emptyState = document.getElementById('emptyState');
        const openBtns = [document.getElementById('openModal'), document.getElementById('openModalDesktop')];
        const inputModal = document.getElementById('inputModal');
        const cancelLoad = document.getElementById('cancelLoad');
        const confirmLoad = document.getElementById('confirmLoad');
        const modalProdName = document.getElementById('modalProdName');
        const errorName = document.getElementById('errorName');
        const notifContainer = document.getElementById('notification-center');

        // Initial State
        const savedProducts = JSON.parse(localStorage.getItem('m2belt_products') || '[]');
        const savedCounter = parseInt(localStorage.getItem('m2belt_counter') || '0');
        const state = {
            speedP: parseInt(localStorage.getItem('m2belt_speedP') || '177'), 
            speedR: parseInt(localStorage.getItem('m2belt_speedR') || '120'), 
            products: savedProducts,
            counter: savedCounter,
            lastFrameTime: performance.now(),
            textureOffsets: [0, 0]
        };

        const PRODUCT_COLORS = ["#22c55e", "#ef4444", "#3b82f6", "#a855f7", "#f59e0b", "#ec4899", "#14b8a6"];

        function notify(msg, isProcess = false) {
            const toast = document.createElement('div');
            toast.className = 'notif-toast';
            if(isProcess) toast.style.borderLeftColor = '#f59e0b';
            toast.innerHTML = `<div class="text-[8px] font-black text-blue-500 uppercase tracking-widest mb-1">SYSTEM ALERT</div>
                               <div class="text-white font-bold text-xs">${msg}</div>`;
            notifContainer.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-10px)';
                setTimeout(() => toast.remove(), 300);
            }, 5000);
            
            if (Notification.permission === "granted") {
                new Notification("M2Belt Sync", { body: msg });
            }
        }

        document.getElementById('requestNotif').onclick = () => {
            Notification.requestPermission().then(perm => {
                if(perm === 'granted') notify("Notifications Enabled");
            });
        };

        function saveToStorage() {
            const cleanData = state.products.map(p => ({
                id: p.id, name: p.name, stage: p.stage,
                startTime: p.startTime, returnStartTime: p.returnStartTime,
                uturnStart: p.uturnStart, currentPos: p.currentPos,
                entryClock: p.entryClock, exitClock: p.exitClock,
                color: p.color, notifiedWater: p.notifiedWater, notifiedFall: p.notifiedFall,
                subZone: p.subZone, colorIndex: p.colorIndex
            }));
            localStorage.setItem('m2belt_products', JSON.stringify(cleanData));
            localStorage.setItem('m2belt_counter', state.counter.toString());
            localStorage.setItem('m2belt_speedP', state.speedP.toString());
            localStorage.setItem('m2belt_speedR', state.speedR.toString());
        }

        speedS1.oninput = (e) => { state.speedP = parseInt(e.target.value); saveToStorage(); };
        speedS2.oninput = (e) => { state.speedR = parseInt(e.target.value); saveToStorage(); };

        function syncProgress(p) {
            const now = Date.now();
            if (p.stage === 'p-belt') {
                const elapsedMin = (now - p.startTime) / 60000;
                const dist = state.speedP * elapsedMin;
                return { dist: Math.min(dist, P_LENGTH), isFin: dist >= P_LENGTH, rem: Math.max(0, (P_LENGTH - dist) / state.speedP) };
            } else if (p.stage === 'r-belt') {
                const elapsedMin = (now - p.returnStartTime) / 60000;
                const dist = state.speedR * elapsedMin;
                return { dist: Math.min(dist, R_LENGTH), isFin: dist >= R_LENGTH, rem: Math.max(0, (R_LENGTH - dist) / state.speedR) };
            }
            return { dist: 0, isFin: false, rem: 0 };
        }

        openBtns.forEach(btn => btn.onclick = () => { inputModal.style.display = 'flex'; errorName.classList.add('hidden'); });
        cancelLoad.onclick = () => { inputModal.style.display = 'none'; };
        
        confirmLoad.onclick = () => {
            const name = modalProdName.value.trim();
            const numVal = parseInt(name);
            if (isNaN(numVal) || numVal < 1 || numVal > 45 || name.length !== 3) { 
                errorName.classList.remove('hidden'); 
                return; 
            }

            const startOver = document.getElementById('modalStartTime').value;
            let now = Date.now();
            if (startOver) {
                const [h, m] = startOver.split(':');
                const d = new Date(); d.setHours(h, m, 0, 0);
                now = d.getTime();
            }

            const hqDur = (P_LENGTH / state.speedP) * 60000;
            const htDur = (R_LENGTH / state.speedR) * 60000;
            const estExit = now + hqDur + UTURN_MS + htDur;

            const colorIdx = Math.floor(state.counter / 2) % PRODUCT_COLORS.length;
            const productCol = PRODUCT_COLORS[colorIdx];

            state.products.push({
                id: `ID-${name}`, name, stage: 'p-belt', startTime: now,
                returnStartTime: null, uturnStart: null, currentPos: 0,
                entryClock: now, exitClock: estExit, element: null,
                color: productCol, colorIndex: colorIdx,
                notifiedWater: false, notifiedFall: false, subZone: "OIL ZONE"
            });
            
            state.counter++;
            modalProdName.value = '';
            inputModal.style.display = 'none';
            saveToStorage();
            updateEmptyState();
        };

        function formatClock(ts) {
            if (!ts) return "--:--";
            return new Date(ts).toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit' });
        }

        function formatTimeRemaining(m) {
            const mins = Math.floor(m);
            const secs = Math.floor((m % 1) * 60);
            return `${mins}m ${secs}s`;
        }

        function animate(frameTime) {
            const now = Date.now();
            const dt = frameTime - state.lastFrameTime;
            state.lastFrameTime = frameTime;

            document.getElementById('speedVal1').innerText = state.speedP;
            document.getElementById('speedVal2').innerText = state.speedR;

            state.textureOffsets[0] = (state.textureOffsets[0] + (state.speedP / 12000) * dt) % 40;
            state.textureOffsets[1] = (state.textureOffsets[1] - (state.speedR / 12000) * dt) % 40;
            document.getElementById('texture1').style.transform = `translateX(${state.textureOffsets[0]}px)`;
            document.getElementById('texture2').style.transform = `translateX(${state.textureOffsets[1]}px)`;

            const activeP = new Set(), activeR = new Set();
            let uturnCount = 0;
            let stateChanged = false;
            let subZonePresence = { oil: false, water: false, fall: false };

            for (let i = state.products.length - 1; i >= 0; i--) {
                const p = state.products[i];
                const sync = syncProgress(p);

                if (p.stage === 'p-belt') {
                    p.currentPos = sync.dist;
                    activeP.add(Math.min(Math.floor(p.currentPos / (P_LENGTH / 5)) + 1, 5));
                    
                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        document.getElementById('belt1').appendChild(p.element);
                    }
                    p.element.style.backgroundColor = p.color;
                    p.element.innerHTML = `<span class="opacity-60 text-[6px] font-black">${p.id}</span><span class="font-black">${p.name}</span>`;
                    const pct = (p.currentPos / P_LENGTH);
                    const bEl = document.getElementById('belt1');
                    p.element.style.transform = `translateX(${pct * (bEl.offsetWidth - p.element.offsetWidth)}px)`;

                    if (sync.isFin) {
                        p.stage = 'u-turn';
                        p.uturnStart = p.startTime + ((P_LENGTH / state.speedP) * 60000);
                        if (p.element) { p.element.remove(); p.element = null; }
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'u-turn') {
                    uturnCount++;
                    const elapsedMs = now - p.uturnStart;
                    const elapsedMin = elapsedMs / 60000;
                    const pct = Math.min(elapsedMs / UTURN_MS, 1);

                    // Add visual element for tank if missing
                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        document.getElementById('beltTank').appendChild(p.element);
                    }
                    p.element.style.backgroundColor = p.color;
                    p.element.innerHTML = `<span class="opacity-60 text-[6px] font-black">${p.id}</span><span class="font-black">${p.name}</span>`;
                    const bEl = document.getElementById('beltTank');
                    p.element.style.transform = `translateX(${pct * (bEl.offsetWidth - p.element.offsetWidth)}px)`;

                    if (elapsedMin < 15) { p.subZone = "OIL ZONE"; subZonePresence.oil = true; } 
                    else if (elapsedMin < 20) {
                        p.subZone = "WATER ZONE"; subZonePresence.water = true;
                        if (!p.notifiedWater) { notify(`Unit ${p.name} -> Water`, true); p.notifiedWater = true; stateChanged = true; }
                    } else {
                        p.subZone = "FALL ZONE"; subZonePresence.fall = true;
                        if (!p.notifiedFall) { notify(`Unit ${p.name} -> Fall`, true); p.notifiedFall = true; stateChanged = true; }
                    }

                    if (elapsedMs >= UTURN_MS) {
                        p.stage = 'r-belt';
                        p.returnStartTime = p.uturnStart + UTURN_MS;
                        if (p.element) { p.element.remove(); p.element = null; }
                        stateChanged = true;
                    }
                } 
                else if (p.stage === 'r-belt') {
                    p.currentPos = sync.dist;
                    activeR.add(Math.min(Math.floor(p.currentPos / (R_LENGTH / 4)) + 1, 4));

                    if (!p.element) {
                        p.element = document.createElement('div');
                        p.element.className = 'product';
                        document.getElementById('belt2').appendChild(p.element);
                    }
                    p.element.style.backgroundColor = p.color;
                    p.element.innerHTML = `<span class="opacity-60 text-[6px] font-black">${p.id}</span><span class="font-black">${p.name}</span>`;
                    const pct = (p.currentPos / R_LENGTH);
                    const bEl = document.getElementById('belt2');
                    p.element.style.transform = `translateX(${(bEl.offsetWidth - p.element.offsetWidth) - (pct * (bEl.offsetWidth - p.element.offsetWidth))}px)`;

                    if (sync.isFin) {
                        if (p.element) p.element.remove();
                        state.products.splice(i, 1);
                        stateChanged = true;
                        updateEmptyState();
                    }
                }
            }

            if (stateChanged) saveToStorage();
            
            document.querySelectorAll('.zone-overlay').forEach(el => {
                const b = el.dataset.belt, z = parseInt(el.dataset.zone);
                if ((b == "1" && activeP.has(z)) || (b == "2" && activeR.has(z))) el.classList.add('zone-active');
                else el.classList.remove('zone-active');
            });

            const updateTankOverlay = (id, active) => {
                const el = document.getElementById(id);
                if (active) el.classList.add('zone-active');
                else el.classList.remove('zone-active');
            }
            updateTankOverlay('tank-oil', subZonePresence.oil);
            updateTankOverlay('tank-water', subZonePresence.water);
            updateTankOverlay('tank-fall', subZonePresence.fall);

            document.getElementById('uturnCount').innerText = uturnCount;
            document.getElementById('pCount').innerText = `U: ${state.products.filter(x => x.stage === 'p-belt').length}`;
            document.getElementById('rCount').innerText = `U: ${state.products.filter(x => x.stage === 'r-belt').length}`;

            if (state.products.length > 0) renderTable();
            requestAnimationFrame(animate);
        }

        function renderTable() {
            let html = '';
            const now = Date.now();
            state.products.forEach(p => {
                const sync = syncProgress(p);
                let status = `<span class="text-blue-400 font-bold uppercase text-[9px]">HQ</span>`;
                let remTxt = formatTimeRemaining(sync.rem);

                if (p.stage === 'u-turn') {
                    status = `<span class="text-amber-500 font-bold uppercase text-[9px]">${p.subZone.split(' ')[0]}</span>`;
                    remTxt = formatTimeRemaining((UTURN_MS - (now - p.uturnStart)) / 60000);
                } else if (p.stage === 'r-belt') {
                    status = `<span class="text-green-400 font-bold uppercase text-[9px]">HT</span>`;
                }

                html += `<tr class="border-t border-slate-800/50 hover:bg-white/5">
                    <td class="px-4 md:px-6 py-4">
                        <div class="font-black text-slate-200 tracking-tighter flex items-center gap-2">
                            <div class="w-2 h-2 rounded-sm" style="background-color: ${p.color}"></div> ${p.name}
                        </div>
                        <div class="text-[8px] text-slate-500 font-bold uppercase tracking-widest ml-4">${p.id}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4">
                        <div class="text-blue-400 font-mono text-[10px] whitespace-nowrap">IN ${formatClock(p.entryClock)}</div>
                        <div class="text-green-400 font-mono text-[10px] mt-0.5 whitespace-nowrap">OUT ${formatClock(p.exitClock)}</div>
                    </td>
                    <td class="px-4 md:px-6 py-4 text-center font-mono text-slate-400 text-[10px]">${p.stage === 'u-turn' ? 'TANK' : p.currentPos.toFixed(0)}</td>
                    <td class="px-4 md:px-6 py-4">${status}</td>
                    <td class="px-4 md:px-6 py-4 text-right font-mono text-slate-500 font-bold">${remTxt}</td>
                </tr>`;
            });
            trackingBody.innerHTML = html;
        }

        function updateEmptyState() { emptyState.style.display = state.products.length === 0 ? 'block' : 'none'; }
        
        window.addEventListener('resize', () => {
            state.products.forEach(p => { if (p.element) p.element.style.transform = ''; });
        });

        updateEmptyState();
        requestAnimationFrame(animate);
    </script>
</body>
</html>
